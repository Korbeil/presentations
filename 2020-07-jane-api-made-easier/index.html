<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Avec Jane, simplifiez-vous la consommation d'API... et bien plus !</title>

        <link rel="stylesheet" href="dist/reset.css">
        <link rel="stylesheet" href="dist/reveal.css">
        <link rel="stylesheet" href="dist/theme/jolicode-dark.css" id="theme">
        <link rel="stylesheet" href="dist/fontawesome/css/all.css">

        <!-- Theme used for syntax highlighted code -->
        <link rel="stylesheet" href="plugin/highlight/darcula.css" id="highlight-theme">
    </head>

    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h1>Jane</h1>
                    <h3>Simplifiez-vous la consommation d'API... et bien plus !</h3>

                    <aside class="notes">
                        Coucou, toi qui lis ces notes üëã
                    </aside>
                </section>

                <section>
                    <h3 class="no-caps">Baptiste Leduc</h3>

                    <p>
                        <img src="img/moi.jpg" alt="@Korbeil_"
                             style="width: 5em; background-color: white; border: 5px solid white !important; display: inline-block; border-radius: 5px; padding: 0;margin: 0 auto;">
                        <img src="img/logo-fond-noir.svg" alt="JoliCode" style="height: 2em; display: inline-block; margin-left: 1em; margin-bottom: 60px;">
                    </p>

                    <div style="display: flex;">
                        <div style="width: 100%;">
                            <ul>
                                <li>üêò D√©veloppeur PHP</li>
                            </ul>
                        </div>
                    </div>

                    <div style="display: flex;">
                        <div style="width: 50%;">
                            <ul>
                                <li> <img src="img/afup-icon-color.png" alt="AFUP" style="height: 40px; vertical-align: middle; margin: auto;">&nbsp;&nbsp;AFUP</li>
                                <li>üèÑ‚ÄçÔ∏è Wakeboard</li>
                            </ul>
                        </div>

                        <div style="width: 50%;">
                            <ul>
                                <li><i class="fab fa-github"></i> github.com/Korbeil</li>
                                <li><i class="fab fa-twitter"></i> twitter.com/Korbeil_</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>Un peu de contexte ...</h2>

                    <aside class="notes">
                        - La Docker engine API avait une spec OpenAPI et Joel a donc cr√©e Jane pour g√©n√©rer un client pour celle-ci.<br/>
                        - Le nom: Generator / JoliCode => Janerator => Jane
                    </aside>
                </section>

                <section>
                  <img src="img/logo_jane_full.svg" alt="logo Jane" />

                  <p> üå± Jane is a set of libraries to generate Models & API Clients based on JSON Schema / OpenAPI specs</p>

                  <aside class="notes">
                    - C'est notre logo, il est beau ?<br/>
                    - Phrase cit√© de notre repo<br/>
                    - Jane √ßa permet de g√©n√©rer des fichiers pour gagner du temps !<br/>
                    - Ces fichiers permettent l'utilisation de DTO ou d'API
                  </aside>
                </section>

                <section>
                  <h2 class="no-caps">Elasticsearch</h2>
                  <h3>Via Elastically</h3>

                  <a href="https://github.com/janephp/demo-with-elasticsearch"><i class="fab fa-github"></i> janephp/demo-with-elasticsearch</a>

                  <aside class="notes">
                    - Cas pratique avec Elasticsearch<br/>
                    - En utilisant Elastically (surcouche de Elastica, disponible sur l'org JoliCode)<br/>
                    - Je ne couvrirais pas la partie sur ElasticSearch (doc Elastica/Elastically)<br/>  
                    - C'est une application SF avec une base PostGres<br/>
                    - J'utilise un jeu de donn√©es avec une entit√© "bi√®re"
                  </aside>
              </section>

              <section>
                  <h3>Mon mod√®le</h3>

                  <pre><code class="bash">project/config/jane/json-schema.json</code></pre>
                  <pre><code class="javascript" data-trim data-noescape>
{
  "type": "object",
  "properties": {
    "name": { "type": "string" },
    "brewer": { "type": "string" },
    "style": { "type": "string" },
    "volume": { "type": "integer" },
    "alcohol": { "type": "integer" },
    "country": { "type": "string" },
    "color": { "type": "string" }
  }
}
                  </code></pre>

                  <aside class="notes">
                    - Avant d'utiliser Jane, il faut repr√©senter ma donn√©e<br/>
                    - Ici on a un JSON Schema qui corresponds √† peu pr√®s √† notre entit√©<br/>
                    - On va l'utiliser pour g√©n√©rer un mod√®le et un normalizer via Jane
                  </aside>
              </section>

              <section>
                <h2 class="no-caps">JSON Schema</h2>
                <a href="https://json-schema.org/specification.html"><i class="fa fa-link"></i> 2019-09</a><br/>

                <ul>
                    <li class="fragment">Description</li>
                    <li class="fragment">Validation</li>
                </ul>

                <aside class="notes">
                    - Comme son nom l'indique, √ßa permet de d√©crire des documents JSON<br/>
                    - Description<br/>
                    - Validation<br/>
                    - La derni√®re version, c'est 2019-09
                </aside>
            </section>

            <section>
                <section>
                    <h2 class="no-caps">JSON Schema</h2>

                    <pre><code class="javascript" data-trim data-noescape>
{
  "type": "object",
  "properties": {
    "name": { "type": "string" },
    "brewer": { "type": "string" },
    "style": { "type": "string" },
    "volume": { "type": "integer" },
    "alcohol": { "type": "integer" },
    "country": { "type": "string" },
    "color": { "type": "string" }
  }
}
                    </code></pre>
                </section>

                <section>
                    <h3>Validation</h3>

                    <pre><code class="javascript" data-trim data-noescape data-line-numbers="7-10">
{
  "type": "object",
  "properties": {
    "name": { "type": "string" },
    "brewer": { "type": "string" },
    "style": { "type": "string" },
    "volume": {
      "type": "integer",
      "minimum": 0
    },
    "alcohol": { "type": "integer" },
    "country": { "type": "string" },
    "color": { "type": "string" }
  }
}
                    </code></pre>
                </section>

                <section>
                    <h3>Tableau d'objets</h3>

                    <pre><code class="javascript" data-trim data-noescape data-line-numbers="4-9">
{
  "type": "object",
  "properties": {
    "names": { 
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "brewer": { "type": "string" },
    "style": { "type": "string" },
    "volume": { "type": "integer" },
    "alcohol": { "type": "integer" },
    "country": { "type": "string" },
    "color": { "type": "string" }
  }
}
                    </code></pre>
                </section>

                <section>
                    <h3>Les r√©f√©rences</h3>

                    <pre><code class="javascript" data-trim data-noescape data-line-numbers="2|7,14-20">
{
  "definitions": {
    "Beer": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "brewer": { "$ref": "#/definitions/Brewer" },
        "style": { "type": "string" },
        "volume": { "type": "integer" },
        "alcohol": { "type": "integer" },
        "color": { "type": "string" }
      }
    },
    "Brewer": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "country": { "type": "string" }
      }
    }
  }
}
                    </code></pre>
                </section>
            </section>

            <section>
              <h2>Configuration</h2>

              <pre><code class="bash">project/config/jane/json_schema.php</code></pre>
              <pre><code class="javascript" data-trim data-noescape>
return [
    'json-schema-file' => __DIR__ . '/json-schema.json',
    'root-class' => 'Beer',
    'namespace' => 'Generated',
    'directory' => __DIR__ . '/../../generated',
];
              </code></pre>

              <aside class="notes">
                - Configuration Jane<br/>
                - "json-schema-file" -> Sch√©ma source<br/>
                - "root-class" -> Permet de donner le nom de la classe "root" si elle existe<br/>
                - "namespace" -> Namespace PHP<br/>
                - "directory" -> dossier de sortie des fichiers g√©n√©r√©s
              </aside>
            </section>

            <section>
              <h2>G√©n√©ration</h2>

              <pre><code class="bash" data-trim data-noescape>
vendor/bin/jane generate -c config/jane/json_schema.php
              </code></pre>

              <aside class="notes">
                - On envoit notre configuration a Jane qui va g√©n√©rer nos fichiers<br/>
                - Si vous utilisez Symfony, vous avez un recipe qui vous ajoutera un binaire pour faire √ßa plus simplement
              </aside>
            </section>

              <section>
                <h2>Fichiers g√©n√©r√©s</h2>
                <h3>Mod√®les</h3>

                <pre><code class="php" data-trim data-noescape data-line-numbers="1|8,14|50-53|61-65">
class Beer
{
    /**
     * 
     *
     * @var string
     */
    protected $name;
    /**
     * 
     *
     * @var string
     */
    protected $brewer;
    /**
     * 
     *
     * @var string
     */
    protected $style;
    /**
     * 
     *
     * @var int
     */
    protected $volume;
    /**
     * 
     *
     * @var int
     */
    protected $alcohol;
    /**
     * 
     *
     * @var string
     */
    protected $country;
    /**
     * 
     *
     * @var string
     */
    protected $color;
    /**
     * 
     *
     * @return string
     */
    public function getName() : string
    {
        return $this->name;
    }
    /**
     * 
     *
     * @param string $name
     *
     * @return self
     */
    public function setName(string $name) : self
    {
        $this->name = $name;
        return $this;
    }
    /**
     * 
     *
     * @return string
     */
    public function getBrewer() : string
    {
        return $this->brewer;
    }
    /**
     * 
     *
     * @param string $brewer
     *
     * @return self
     */
    public function setBrewer(string $brewer) : self
    {
        $this->brewer = $brewer;
        return $this;
    }
    /**
     * 
     *
     * @return string
     */
    public function getStyle() : string
    {
        return $this->style;
    }
    /**
     * 
     *
     * @param string $style
     *
     * @return self
     */
    public function setStyle(string $style) : self
    {
        $this->style = $style;
        return $this;
    }
    /**
     * 
     *
     * @return int
     */
    public function getVolume() : int
    {
        return $this->volume;
    }
    /**
     * 
     *
     * @param int $volume
     *
     * @return self
     */
    public function setVolume(int $volume) : self
    {
        $this->volume = $volume;
        return $this;
    }
    /**
     * 
     *
     * @return int
     */
    public function getAlcohol() : int
    {
        return $this->alcohol;
    }
    /**
     * 
     *
     * @param int $alcohol
     *
     * @return self
     */
    public function setAlcohol(int $alcohol) : self
    {
        $this->alcohol = $alcohol;
        return $this;
    }
    /**
     * 
     *
     * @return string
     */
    public function getCountry() : string
    {
        return $this->country;
    }
    /**
     * 
     *
     * @param string $country
     *
     * @return self
     */
    public function setCountry(string $country) : self
    {
        $this->country = $country;
        return $this;
    }
    /**
     * 
     *
     * @return string
     */
    public function getColor() : string
    {
        return $this->color;
    }
    /**
     * 
     *
     * @param string $color
     *
     * @return self
     */
    public function setColor(string $color) : self
    {
        $this->color = $color;
        return $this;
    }
}
                </code></pre>
              </section>

              <section>
                <h2>Serializer ?</h2>

                <img src="img/serializer_workflow.svg" alt="Serializer" /><br/>

                <a href="https://github.com/schmittjoh/serializer"><i class="fab fa-github"></i> symfony/serializer</a><br/>
                <a href="https://github.com/schmittjoh/serializer"><i class="fab fa-github"></i> jms/serializer</a>

                <aside class="notes">
                  - Un Serializer, c'est une librairie qui permet de transformer un objet dans un format sp√©cifique (XML, JSON, YAML, ...) et dans l'autre sens aussi ...<br/>
                  <br/>
                  As you can see in the picture above, an array is used as an intermediary between objects and serialized contents. This way, encoders will only deal with turning specific formats into arrays and vice versa. The same way, Normalizers will deal with turning specific objects into arrays and vice versa.
                </aside>
              </section>
              
              <section>
                <h3>Normalizers</h3>

                <pre><code class="php" data-trim data-noescape data-line-numbers="1|6-9|14,22-28|10-13|46,48-54">
class BeerNormalizer implements DenormalizerInterface, NormalizerInterface, DenormalizerAwareInterface, NormalizerAwareInterface
{
    use DenormalizerAwareTrait;
    use NormalizerAwareTrait;
    use CheckArray;
    public function supportsDenormalization($data, $type, $format = null)
    {
        return $type === 'Generated\\Model\\Beer';
    }
    public function supportsNormalization($data, $format = null)
    {
        return $data instanceof \Generated\Model\Beer;
    }
    public function denormalize($data, $class, $format = null, array $context = array())
    {
        if (isset($data['$ref'])) {
            return new Reference($data['$ref'], $context['document-origin']);
        }
        if (isset($data['$recursiveRef'])) {
            return new Reference($data['$recursiveRef'], $context['document-origin']);
        }
        $object = new \Generated\Model\Beer();
        if (\array_key_exists('name', $data)) {
            $object->setName($data['name']);
        }
        if (\array_key_exists('brewer', $data)) {
            $object->setBrewer($data['brewer']);
        }
        if (\array_key_exists('style', $data)) {
            $object->setStyle($data['style']);
        }
        if (\array_key_exists('volume', $data)) {
            $object->setVolume($data['volume']);
        }
        if (\array_key_exists('alcohol', $data)) {
            $object->setAlcohol($data['alcohol']);
        }
        if (\array_key_exists('country', $data)) {
            $object->setCountry($data['country']);
        }
        if (\array_key_exists('color', $data)) {
            $object->setColor($data['color']);
        }
        return $object;
    }
    public function normalize($object, $format = null, array $context = array())
    {
        $data = array();
        if (null !== $object->getName()) {
            $data['name'] = $object->getName();
        }
        if (null !== $object->getBrewer()) {
            $data['brewer'] = $object->getBrewer();
        }
        if (null !== $object->getStyle()) {
            $data['style'] = $object->getStyle();
        }
        if (null !== $object->getVolume()) {
            $data['volume'] = $object->getVolume();
        }
        if (null !== $object->getAlcohol()) {
            $data['alcohol'] = $object->getAlcohol();
        }
        if (null !== $object->getCountry()) {
            $data['country'] = $object->getCountry();
        }
        if (null !== $object->getColor()) {
            $data['color'] = $object->getColor();
        }
        return $data;
    }
}
                </code></pre>
              </section>

              <section>
                  <h3>Indexation</h3>

                  <pre><code class="bash">project/src/Command/IndexCommand.php</code></pre>
                  <pre><code class="php" data-trim data-noescape data-line-numbers="3-12">
// On va r√©cup√©rer l'index Elasticsearch

$beers = $this->beerRepository->findAll();
foreach ($beers as $beer) {
  $model = new \Generated\Beer();
  $model->setName($beer->getName());
  $model->setBrewer($beer->getBrewer());
  $model->setStyle($beer->getStyle());
  $model->setVolume($beer->getVolume());
  $model->setAlcohol($beer->getAlcohol());
  $model->setCountry($beer->getCountry());
  $model->setColor($beer->getColor());

  $document = new \Elastica\Document($beer->getId(), $model);
  $indexer->scheduleIndex(self::BEERS_INDEX, $document);
}

// Puis on envoit les documents √† Elasticsearch
                  </code></pre>

                  <aside class="notes">
                      - On aura configur√© Elasticsearch au pr√©alable<br/>
                      - On boucle sur nos entit√©s pour les transformers en notre mod√®le<br/>
                      - Et on envoit ce mod√®le √† ES<br/>
                      - Mais ... c'est chiant de faire ces set/get ...
                  </aside>
              </section>

            <section>
                <h2>AutoMapper</h2>

                <a href="https://github.com/janephp/automapper"><i class="fab fa-github"></i> janephp/automapper</a>

                <aside class="notes">
                  - Pas seulement JSON Schema / OpenAPI chez Jane<br/>
                  - Jane = g√©n√©ration de fichiers PHP gr√¢ce √† l'AST<br/>
                </aside>
            </section>

            <section>
                <section>
                    <h3>C'est quoi ?</h3>
                    <h4>Serializer</h4>

                    <div style="background-color: #FFF;">
                      <img src="img/symfony.png" alt="Sch√©ma Symfony" style="margin-top: 1em;" />
                    </div>

                    <aside class="notes">
                      - G√©n√©ralement, dans un Serializer, quand on fait une Denormalization, on va transformer un array en objet<br/>
                      - Dans Symfony pour faire √ßa, on va passer par l'ObjectNormalizer<br/>
                      - Le soucis c'est que l'ObjectNormalizer utilise la Reflection pour mapper les propri√©t√©s de notre objet (idem dans JMS)<br/>
                      - Et la Reflection c'est lourd !
                    </aside>
                </section>

                <section>
                    <h4>Jane</h4>

                    <div style="background-color: #FFF;">
                      <img src="img/automapper.png" alt="Sch√©ma Jane AutoMapper" style="margin-top: 1em;" />
                    </div>

                    <aside class="notes">
                        - Et c'est l√† que l'AutoMapper vient<br/>
                        - Il va lui aussi utiliser la Reflection pour r√©cup√©rer les propri√©t√©s √† normalizer<br/>
                        - Mais la diff√©rence c'est qu'on va g√©n√©rer un Transformer pour faire la normalization<br/>
                        - Du coup, la cr√©ation du Transformer ne se fera qu'une fois, puis ensuite on utilise le Transformer<br/>
                        - Et donc, la Reflection ne sera appell√© qu'une seule fois !<br/>
                        - Ce Transformer est uni-lat√©ral<br/>
                        - Enti√®rement compatible avec le Serializer symfony (toutes les features sont pr√©sentes !)<br/>
                        - Permet aussi de faire de l'hydratation ou deep copy<br/>
                        - On peut faire: Object -> Array, Array -> Object, Object -> Object, Array -> Array
                    </aside>
                </section>
            </section>

            <section>
                <section>
                    <h3>Et en pratique ?</h3>
                    <h4>Un utilisateur</h4>

                    <pre><code class="php" data-trim data-noescape style="max-height: 450px;">
class User
{
  private int $id;
  public string $name;
  public int $age;

  public function __construct(int $id, string $name, int $age)
  {
      $this->id = $id;
      $this->name = $name;
      $this->age = $age;
  }

  public function getId(): int
  {
      return $this->id;
  }
}
                    </code></pre>

                    <aside class="notes">
                        - Un objet pour nos exemples !
                    </aside>
                </section>

                <section>
                    <h4>Un utilisateur (simplifi√©)</h4>

                    <pre><code class="php" data-trim data-noescape style="max-height: 450px;">
class UserName
{
  public string $name;
}
                    </code></pre>

                    <aside class="notes">
                        - Et un autre objet (c'est le dernier)
                    </aside>
                </section>

                <section>
                    <h4>Depuis un tableau</h4>

                    <pre><code class="php" data-trim data-noescape>
$source = [
'id' => 42,
'name' => 'Bastien',
'age' => 30,
];

$target = $automapper->map($source, User::class);
$target = new UserName();
$target = $automapper->map($source, $target);
                    </code></pre>

                    <aside class="notes">
                        - A partir d'un array on peut transformer en object<br/>
                        - En donnant la classe de l'objet voulu<br/>
                        - En donnant un objet d√©j√† existant !<br/>
                    </aside>
                </section>

                <section>
                    <h4>Vers un tableau</h4>

                    <pre><code class="php" data-trim data-noescape>
$source = new User(42, 'Bastien', 30);
$target = $automapper->map($source, 'array');
                    </code></pre>

                    <aside class="notes">
                        - A partir d'un objet on peut transformer en array
                    </aside>
                </section>

                <section>
                    <h4>D'un objet vers un objet</h4>

                    <pre><code class="php" data-trim data-noescape>
$source = new User(42, 'Bastien', 30);
$target = $automapper->map($source, UserName::class);
                    </code></pre>

                    <aside class="notes">
                        - A partir d'un objet on peut transformer en ... objet !
                    </aside>
                </section>
            </section>

            <section>
              <h3>Indexation</h3>

              <pre><code class="bash">project/src/Command/IndexCommand.php</code></pre>
              <pre><code class="php" data-trim data-noescape data-line-numbers="3-12">
// On va r√©cup√©rer l'index Elasticsearch

$beers = $this->beerRepository->findAll();
foreach ($beers as $beer) {
  $model = $this->autoMapper->map($beer, \Generated\Beer::class);
  $document = new \Elastica\Document($beer->getId(), $model);
  $indexer->scheduleIndex(self::BEERS_INDEX, $document);
}

// Puis on envoit les documents √† Elasticsearch
              </code></pre>

              <aside class="notes">
                - Et maintenant avec l'AutoMapper :)
              </aside>
          </section>

              <section>
                  <h3>R√©cup√©ration</h3>

                  <pre><code class="bash">project/src/Controller/BeerController.php</code></pre>
                  <pre><code class="php" data-trim data-noescape>
// On r√©cup√®re tous les Document de notre index

$output = ['beers' => []];
foreach ($results as $result) {
  $output['beers'][] = $result->getModel();
}

return $this->json($output);
                  </code></pre>

                  <aside class="notes">
                      - Gr√¢ce √† Elastically, notre r√©sultat est pass√© dans le Serializer Symfony<br/>
                      - Il va alors trouver le Normalizer qui a √©t√© g√©n√©r√© par Jane<br/>
                      - Et du coup on aura une liste de mod√®les qu'on peut revoyer soit directement, traiter ou donner √† Twig
                  </aside>
              </section>

              <section>
                  <h3>Rendu</h3>

                  <img src="img/demo-elasticsearch.png" alt="Rendu d√©mo - Elasticsearch" />
              </section>

<!-- REORG -->

                <section>
                  <h2 class="no-caps">OpenAPI</h2>

                  <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.3.md"><i class="far fa-hand-point-right"></i> actual: 3.0.3</a><br/>
                  <a href="https://github.com/OAI/OpenAPI-Specification/issues/1466"><i class="far fa-hand-point-down"></i> next: 3.1.0</a>

                  <aside class="notes">
                      - Et maintenant OpenAPI<br/>
                      - A la base l'id√©e c'√©tait de suivre JSON Schema et d'ajouter la partie "API"<br/>
                      - √áa s'est un peu s√©par√© de JSON Schema avec le temps<br/>
                      - Et justement ! La 3.1 se rattache √† JSON Schema 2019-09 !
                  </aside>
                </section>

                <section>
                    <h2 class="no-caps">OpenAPI</h2>

                    <ul>
                        <li class="fragment">JSON Schema</li>
                        <li class="fragment">Endpoints</li>
                        <li class="fragment">Authentification</li>
                    </ul>

                    <aside class="notes">
                        - On reprends JSON Schema (quelques diff√©rences mais sera ISO √† partir de OpenAPI 3.1)<br/>
                        - Endpoints: param√®tres / body / responses (200-400-500)<br/>
                        - Authentification: header / query / oauth<br/>
                        - Beaucoup plus permissif sur le format d'entr√©e: JSON, YAML
                    </aside>
                </section>

                <section>
                    <section>
                        <h3 class="no-caps">OpenAPI</h3>
                        <h4>Endpoint</h4>

                        <pre><code class="yaml" data-trim data-noescape>
paths:
  /pets:
    get:
      summary: List all pets
      operationId: listPets
      tags:
        - pets
                        </code></pre>
                    </section>

                    <section>
                        <h3>Param√®tres</h3>

                        <pre><code class="yaml" data-trim data-noescape data-line-numbers="8-15">
paths:
  /pets:
    get:
      summary: List all pets
      operationId: listPets
      tags:
        - pets
      parameters:
        - name: limit
          in: query
          description: How many items to return at one time (max 100)
          required: false
          schema:
            type: integer
            format: int32
      responses:
        '200':
          description: A paged array of pets
          headers:
            x-next:
              description: A link to the next page of responses
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Pets"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
                        </code></pre>
                    </section>

                    <section>
                        <h3>R√©ponses</h3>

                        <pre><code class="yaml" data-trim data-noescape data-line-numbers="17-27">
paths:
  /pets:
    get:
      summary: List all pets
      operationId: listPets
      tags:
        - pets
      parameters:
        - name: limit
          in: query
          description: How many items to return at one time (max 100)
          required: false
          schema:
            type: integer
            format: int32
      responses:
        '200':
          description: A paged array of pets
          headers:
            x-next:
              description: A link to the next page of responses
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Pets"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
                        </code></pre>
                    </section>

                    <section>
                        <h3>R√©ponse par d√©faut</h3>

                        <pre><code class="yaml" data-trim data-noescape data-line-numbers="28-33">
paths:
  /pets:
    get:
      summary: List all pets
      operationId: listPets
      tags:
        - pets
      parameters:
        - name: limit
          in: query
          description: How many items to return at one time (max 100)
          required: false
          schema:
            type: integer
            format: int32
      responses:
        '200':
          description: A paged array of pets
          headers:
            x-next:
              description: A link to the next page of responses
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Pets"
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
                        </code></pre>
                    </section>

                    <section>
                        <h3>Authentification</h3>

                        <pre><code class="yaml" data-trim data-noescape data-line-numbers="1-2,9-12|16-25">
components:
  securitySchemes:
    BasicAuth:
      type: http
      scheme: basic
    BearerAuth:
      type: http
      scheme: bearer
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
    OpenID:
      type: openIdConnect
      openIdConnectUrl: https://example.com/.well-known/openid-configuration
    OAuth2:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: https://example.com/oauth/authorize
          tokenUrl: https://example.com/oauth/token
          scopes:
            read: Grants read access
            write: Grants write access
            admin: Grants access to admin operations
                        </code></pre>

                        <aside class="notes">
                            - Authentification indiqu√© au niveau global<br/>
                            - Ensuite on peut sp√©cifier par endpoint quel auth choisir
                        </aside>
                    </section>
                </section>

                <section>
                    <h2>Et Jane ?</h2>

                    <aside class="notes">
                        - Une bonne base !<br/>
                        - Et Jane c'est quoi le rapport ?
                    </aside>
                </section>

                <section>
                    <h3>G√©n√©ration</h3>
                    <h3 class="no-caps">Avec JSON Schema</h3>

                    <a href="https://github.com/janephp/json-schema"><i class="fab fa-github"></i> janephp/json-schema</a>

                    <div style="margin-top: 1em;">
                        <ul>
                            <li class="fragment">Mod√®les</li>
                            <li class="fragment">Normalizers</li>
                        </ul>
                    </div>

                    <aside class="notes">
                        - Mod√®les: Un DTO avec les propri√©t√©s<br/>
                        - Normalizers: Permet la transformation d'un array en objet ou l'inverse<br/>
                        - Les classes g√©n√©r√©s sont optimis√©es pour prendre le moins de temps possible !
                    </aside>
                </section>

                <section>
                    <h3>G√©n√©ration</h3>
                    <h3 class="no-caps">Avec OpenAPI</h3>

                    <a href="https://github.com/janephp/open-api-2"><i class="fab fa-github"></i> janephp/open-api-2</a><br/>
                    <a href="https://github.com/janephp/open-api-3"><i class="fab fa-github"></i> janephp/open-api-3</a>

                    <div style="margin-top: 1em;">
                        <ul>
                            <li class="fragment">JSON Schema</li>
                            <li class="fragment">Client</li>
                            <li class="fragment">Endpoints</li>
                            <li class="fragment">R√©ponse (et exceptions)</li>
                            <li class="fragment">Authentification</li>
                        </ul>
                    </div>

                    <aside class="notes">
                        - Client<br/>
                        - Endpoints<br/>
                        - Response: (Mod√®les pour les r√©ponses + exceptions si 400/500)<br/>
                        - Authentification: Middleware HTTP pour l'ajouter
                    </aside>
                </section>

                <section>
                    <h2 class="no-caps">API Platform</h2>

                    <a href="https://github.com/janephp/demo-with-apiplatform"><i class="fab fa-github"></i> janephp/demo-with-apiplatform</a>

                    <aside class="notes">
                        - Utilisation de JSON Schema avec un output DTO<br/>
                        - Toujours une application SF avec une base PostGres<br/>
                        - J'utilise un jeu de donn√©es avec une entit√© "bi√®re"
                    </aside>
                </section>

                <section>
                    <h3>Mon mod√®le</h3>

                    <pre><code class="bash">project/config/jane/json-schema.json</code></pre>
                    <pre><code class="javascript" data-trim data-noescape>
{
  "type": "object",
  "properties": {
    "name": {
      "type": "string"
    },
    "brewer": {
      "type": "string"
    }
  }
}
                    </code></pre>

                    <aside class="notes">
                        - Ici on a un JSON Schema qui corresponds aux champs que l'on veut en sortie de notre entit√©<br/>
                        - On va l'utiliser pour g√©n√©rer un mod√®le et un normalizer via Jane
                    </aside>
                </section>

                <section>
                    <h3>Configuration</h3>

                    <pre><code class="bash">project/config/api_platform/resources.yaml</code></pre>
                    <pre><code class="yaml" data-trim data-noescape>
resources:
  App\Entity\Beer:
    attributes:
      output: Generated\Model\BeerOutput
                    </code></pre>

                    <aside class="notes">
                        - Configuration d'une resource APIP pour notre entit√© Beer<br/>
                        - On lui indique qu'on aura un DTO de sortie "BeerOutput" qui sera configur√© comme nom de notre mod√®le dans la config Jane
                    </aside>
                </section>

                <section>
                    <section>
                        <h3>Transformation</h3>
                        <h4>Match</h4>

                        <pre><code class="bash" style="overflow-x: hidden;">project/src/DataTransformer/BeerOutputDataTransformer.php</code></pre>
                        <pre><code class="php" data-trim data-noescape data-line-numbers="15-20">
class BeerOutputDataTransformer implements DataTransformerInterface
{
    private AutoMapperInterface $autoMapper;

    public function __construct(AutoMapperInterface $autoMapper)
    {
        $this->autoMapper = $autoMapper;
    }

    public function transform($data, string $to, array $context = [])
    {
        return $this->autoMapper->map($data, BeerOutput::class, $context);
    }

    public function supportsTransformation($data, string $to, array $context = []): bool
    {
        return
            BeerOutput::class === $to &&
            $data instanceof App\Entity\Beer;
    }
}
                        </code></pre>

                        <aside class="notes">
                            - On match les entit√©s Beer<br/>
                            - Avec comme format cibl√© le DTO BeerOutput
                        </aside>
                    </section>

                    <section>
                        <h4>Transformation</h4>
                        
                        <pre><code class="php" data-trim data-noescape data-line-numbers="10-13">
class BeerOutputDataTransformer implements DataTransformerInterface
{
    private AutoMapperInterface $autoMapper;

    public function __construct(AutoMapperInterface $autoMapper)
    {
        $this->autoMapper = $autoMapper;
    }

    public function transform($data, string $to, array $context = [])
    {
        return $this->autoMapper->map($data, BeerOutput::class, $context);
    }

    public function supportsTransformation($data, string $to, array $context = []): bool
    {
        return BeerOutput::class === $to && $data instanceof App\Entity\Beer;
    }
}
                        </code></pre>

                        <aside class="notes">
                            - Et on transforme notre entit√© en DTO ...<br/>
                            - On retrouve l'utilisation de l'AutoMapper pour √©viter 40 lignes de get/set ;)<br/>
                            - Plus rapide (promis je vous reparle de l'AutoMapper plus tard)
                        </aside>
                    </section>
                </section>

                <section>
                    <h3>Rendu</h3>

                    <img src="img/demo-api-platform.png" alt="Rendu d√©mo - API Platform" />
                </section>

                <section>
                    <h2 class="no-caps">API externe</h2>

                    <a href="https://github.com/janephp/demo-external-api"><i class="fab fa-github"></i> janephp/demo-external-api</a>

                    <aside class="notes">
                        - Toujours une application SF<br/>
                        - Objectif: contacter une API externe, sans utiliser son client, souvent trop lourd et parfois s'int√©grant mal avec nos framework (Stripe / Slack ...)
                    </aside>
                </section>

                <section>
                    <section>
                        <h3 class="no-caps">Sch√©ma OpenAPI</h3>
                        <h4>Endpoint</h4>

                        <pre><code class="bash">project/config/jane/open-api.yaml</code></pre>
                        <pre><code class="yaml" data-trim data-noescape data-line-numbers="7-17">
openapi: 3.0.0
info:
  version: 1.0.0
  title: 'CatFacts API'
servers:
  - url: https://cat-fact.herokuapp.com
paths:
  /facts/random:
    get:
      operationId: randomFact
      responses:
        200:
          description: 'Get a random `Fact`'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Fact'
components:
  schemas:
    Fact:
      type: object
      properties:
        _id:
          type: string
          description: 'Unique ID for the `Fact`'
        __v:
          type: integer
          description: 'Version number of the `Fact`'
        user:
          type: string
          description: 'ID of the `User` who added the `Fact`'
        text:
          type: string
          description: 'The `Fact` itself'
        updatedAt:
          type: string
          format: date-time
          description: 'Date in which `Fact` was last modified'
        sendDate:
          type: string
          description: 'If the `Fact` is meant for one time use, this is the date that it is used'
        deleted:
          type: boolean
          description: 'Weather or not the `Fact` has been deleted (Soft deletes are used)'
        source:
          type: string
          description: 'Can be `user` or `api`, indicates who added the fact to the DB'
        used:
          type: boolean
          description: 'Weather or not the `Fact` has been sent by the CatBot. This value is reset each time every `Fact` is used'
        type:
          type: string
          description: 'Type of animal the `Fact` describes (e.g. ‚Äòcat‚Äô, ‚Äòdog‚Äô, ‚Äòhorse‚Äô)'
                        </code></pre>

                        <aside class="notes">
                            - Un endpoint<br/>
                            - On notera le champ "operationId", il va correspondre au nom de la m√©thode du Client g√©n√©r√© pour cet endpoint (si pas de "operationId", on se base sur le path et l'operation [GET/POST/PUT/...])
                        </aside>
                    </section>

                    <section>
                        <h4>Mod√®le</h4>

                        <pre><code class="yaml" data-trim data-noescape data-line-numbers="20-32">
openapi: 3.0.0
info:
  version: 1.0.0
  title: 'CatFacts API'
servers:
  - url: https://cat-fact.herokuapp.com
paths:
  /facts/random:
    get:
      operationId: randomFact
      responses:
        200:
          description: 'Get a random `Fact`'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Fact'
components:
  schemas:
    Fact:
      type: object
      properties:
        _id: { type: string }
        __v: { type: integer }
        user: { type: string }
        text: { type: string }
        updatedAt: { type: string, format: date-time }
        sendDate: { type: string }
        deleted: { type: boolean }
        source: { type: string }
        used: { type: boolean }
        type: { type: string }
                        </code></pre>

                        <aside class="notes">
                            - Le mod√®le correspondant a l'endpoint
                        </aside>
                    </section>
                </section>

                <section>
                    <h3>Configuration de la g√©n√©ration</h3>

                    <pre><code class="bash">project/config/jane/open_api.php</code></pre>
                    <pre><code class="php" data-trim data-noescape>
return [
    'openapi-file' => __DIR__ . '/open-api.yaml',
    'namespace' => 'CatFacts\Api',
    'directory' => __DIR__ . '/../../generated',
    'date-format' => \DateTimeInterface::RFC3339_EXTENDED,
];
                    </code></pre>

                    <aside class="notes">
                        - L'emplacement de notre sch√©ma OpenAPI<br/>
                        - Un joli namespace<br/>
                        - Le dossier de sortie de la g√©n√©ration<br/>
                        - Notre API utilise un format de date particulier (param√®tre optionel ici)
                    </aside>
                </section>

                <section>
                    <h3>Configuration des services</h3>

                    <pre><code class="bash">project/config/packages/jane.yaml</code></pre>
                    <pre><code class="yaml" data-trim data-noescape data-line-numbers="6-10">
services:
    _defaults:
        autowire: true
        autoconfigure: true

    CatFacts\Api\Normalizer\JaneObjectNormalizer: ~

    CatFacts\Api\Client:
        factory: ['CatFacts\Api\Client', 'create']
                    </code></pre>

                    <aside class="notes">
                        - On va ajouter le Normalizer de Jane (avec l'autoconfigure, les Normalizer seront utilis√© dans le Serializer SF)<br/>
                        - Et on cr√©e un service pour le Client API g√©n√©r√© par Jane (via une factory)
                    </aside>
                </section>

                <section>
                    <h3>Controller</h3>

                    <pre><code class="bash" data-trim data-noescape>project/src/Controller/FactController.php</code></pre>
                    <pre><code class="php" data-trim data-noescape>
class FactController extends AbstractController
{
    public function index(CatFacts\Api\Client $client)
    {
        return $this->render('fact.html.twig', [
            'fact' => $client->randomFact(),
        ]);
    }
}
                    </code></pre>

                    <aside class="notes">
                        - On r√©cup√®re le Client g√©n√©r√© par Jane et donn√© comme service √† SF via l'autowire<br/>
                        - Et on utilise notre endpoint qui va renvoyer un mod√®le Fact √† Twig
                    </aside>
                </section>

                <section>
                    <h3>Rendu</h3>

                    <img src="img/demo-external-api.png" alt="Rendu d√©mo - API Externe" />
                </section>

                <section>
                    <h2 class="no-caps">Entre deux applications</h2>

                    <a href="https://github.com/janephp/demo-between-two-apps"><i class="fab fa-github"></i> janephp/demo-between-two-apps</a>

                    <aside class="notes">
                        - Deux applications SF: API & Front<br/>
                        - L'id√©e ici est de montrer les interractions entre et les deux apps <br/>
                        - Et en quoi Jane peut rendre √ßa beaucoup plus simple
                    </aside>
                </section>

                <section>
                    <section>
                        <h3>Un contrat commun</h3>
                        <h4>Endpoint API</h4>

                        <pre><code class="yaml" data-trim data-noescape data-line-numbers="8-21">
openapi: '3.0.2'
info:
  title: Between two apps
  description: Simple OpenAPI
  version: 1.0.0
servers:
  - url: 'http://api/'
paths:
  /beers:
    get:
      summary: Get beers
      operationId: getBeers
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Beer'
components:
  schemas:
    Beer:
      type: object
      properties:
        name:
          type: string
        brewer:
          type: string
        style:
          type: string
        color:
          type: string
        alcohol:
          type: integer
                        </code></pre>

                        <aside class="notes">
                            - L'endpoint corresponds √† un controlleur dans notre API
                        </aside>
                    </section>

                    <section>
                        <h4>Mod√®le</h4>

                        <pre><code class="yaml" data-trim data-noescape data-line-numbers="24-36">
openapi: '3.0.2'
info:
  title: Between two apps
  description: Simple OpenAPI
  version: 1.0.0
servers:
  - url: 'http://api/'
paths:
  /beers:
    get:
      summary: Get beers
      operationId: getBeers
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Beer'
components:
  schemas:
    Beer:
      type: object
      properties:
        name:
          type: string
        brewer:
          type: string
        style:
          type: string
        color:
          type: string
        alcohol:
          type: integer
                        </code></pre>

                        <aside class="notes">
                            - Et un mod√®le qui corresponds √† ce qu'on veut envoyer via l'API de note bi√®re (et donc recevoir c√¥t√© Front)
                        </aside>
                    </section>
                </section>

                <section>
                    <h3>API Controller</h3>

                    <pre><code class="bash" data-trim data-noescape>project/api/src/Controller/BeerController.php</code></pre>
                    <pre><code class="php" data-trim data-noescape>
class BeerController extends AbstractController
{
    public function list(BeerRepository $beerRepository, AutoMapperInterface $autoMapper, NormalizerInterface $normalizer)
    {
        $beers = $beerRepository->findAll();
        $callback = function (\App\Entity\Beer $beer) use ($autoMapper) {
            return $autoMapper->map($beer, \Generated\Model\Beer::class);
        };
        $beerModels = \array_map($callback, $beers);

        return new JsonResponse($normalizer->normalize($beerModels));
    }
}
                    </code></pre>

                    <aside class="notes">
                        - Controller c√¥t√© API<br/>
                        - Le routing est configur√© dans le YAML<br/>
                        - On r√©cup√®re toutes nos entit√©s avec le repository<br/>
                        - On transforme nos entit√©s nos entit√©s en mod√®les Jane (promis je vous en reparle TR√àS bient√¥t de l'AutoMapper)<br/>
                        - Et on renvois √ßa via une JsonReponse !
                    </aside>
                </section>

                <section>
                    <h3>Front Configuration</h3>

                    <pre><code class="bash" data-trim data-noescape>project/front/config/packages/jane.yaml</code></pre>
                    <pre><code class="yaml" data-trim data-noescape data-line-numbers="6-10">
services:
  _defaults:
    autowire: true
    autoconfigure: true

  Generated\Normalizer\JaneObjectNormalizer: ~

  Generated\Client:
    factory: ['Generated\Client', 'create']
                    </code></pre>

                    <aside class="notes">
                        - Comme vu dans la configuration des services de l'exemple API externe<br/>
                        - On va donc ajouter le Normalizer de Jane (autoconfigure -> Serializer SF)<br/>
                        - Et on cr√©e un service pour le Client API g√©n√©r√© par Jane (via une factory)
                    </aside>
                </section>

                <section>
                    <h3>Front Controller</h3>

                    <pre><code class="bash" data-trim data-noescape>project/front/src/Controller/HomeController.php</code></pre>
                    <pre><code class="php" data-trim data-noescape data-line-numbers="3-8">
class HomeController extends AbstractController
{
    public function index(\Generated\Client $client)
    {
        return $this->render('home.html.twig', [
            'beers' => $client->getBeers()
        ]);
    }
}
                    </code></pre>

                    <aside class="notes">
                        - On r√©cup√®re le Client g√©n√©r√© par Jane et donn√© comme service √† SF<br/>
                        - Et on utilise notre endpoint qui va renvoyer une liste de bi√®re √† Twig
                    </aside>
                </section>

                <section>
                    <h3>Rendu</h3>

                    <img src="img/demo-between-two-apps.png" alt="Rendu d√©mo - Entre deux applications" />
                </section>

                <section>
                    <h2>D√©mos</h2>

                    <a href="https://github.com/janephp"><i class="fab fa-github"></i> janephp</a>

                    <aside class="notes">
                        - Comme indiqu√©, toutes les d√©mos sont disponibles sur l'org janephp<br/>
                        - Avec un README d√©taill√© sur comment le projet fonctionne et les sp√©cificit√©s<br/>
                        - Remerciments: <i>docker-starter</i> (permet de g√©rer la stack de dev de chacunes des d√©mos)
                    </aside>
                </section>

                <section>
                    <h1>Merci</h1>
                </section>

                <section>
                  <h3>Des questions ?</h3>
                </section>
            </div>
        </div>

        <footer class="joli">
            Jane, simplifiez-vous la consommation d'API... et bien plus ! - <img src="img/logo-fond-noir.svg" style="height:1em; vertical-align: text-bottom;"/> 2020
        </footer>

        <script src="dist/reveal.js"></script>
        <script src="plugin/notes/notes.js"></script>
        <script src="plugin/markdown/markdown.js"></script>
        <script src="plugin/highlight/highlight.js"></script>

        <script>
            Reveal.initialize({
                hash: true,
                slideNumber: true,

                plugins: [RevealHighlight, RevealNotes]
            });
        </script>
    </body>
</html>